<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Tabla de Resultados - Docente</title>
  <!-- jsPDF y html2canvas para descarga de PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to bottom right, #0a2c58, #ffffff);
      padding: 20px;
      color: #333;
      margin: 0;
    }

    /* ENCABEZADO SUPERIOR */
    .encabezado {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #ffffffcc;
      backdrop-filter: blur(4px);
      padding: 15px 30px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      margin-bottom: 25px;
    }

    .encabezado img {
      height: 80px;
      width: auto;
    }

    .frase {
      text-align: right;
      color: #0a2c58;
      font-style: italic;
      font-size: 20px;
      line-height: 1.2;
      font-weight: 600;
    }

    .contenedor-resultados {
      background-color: #fff;
      padding: 30px;
      border-radius: 15px;
      max-width: 900px;
      margin: 0 auto 40px auto;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    h1 {
      color: #0a2c58;
      border-bottom: 2px solid #4a90e2;
      padding-bottom: 10px;
      margin-bottom: 20px;
      text-align: center;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      background-color: #4a90e2;
      color: white;
      font-weight: bold;
      text-transform: uppercase;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    tr:hover {
      background-color: #f1f8ff;
    }

    .btn-accion {
      padding: 6px 10px;
      margin: 2px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s, opacity 0.2s;
      min-width: 80px;
      font-size: 13px;
    }

    .btn-editar {
      background-color: #ffc107;
      color: #212529;
    }

    .btn-editar:hover {
      background-color: #e0a800;
    }

    .btn-eliminar {
      background-color: #dc3545;
      color: white;
    }

    .btn-eliminar:hover {
      background-color: #c82333;
    }

    .btn-eliminar:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-activo {
      background-color: #28a745;
      color: white;
    }

    .btn-activo:hover {
      background-color: #218838;
    }

    .btn-inactivo {
      background-color: #6c757d;
      color: white;
      opacity: 0.8;
      cursor: not-allowed;
    }

    .btn-volver {
      background-color: #6c757d;
      color: white;
      margin-bottom: 20px;
    }

    .btn-volver:hover {
      background-color: #5a6268;
    }

    .header-acciones {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .btn-agregar {
      background-color: #4a90e2;
      color: white;
    }

    .btn-agregar:hover {
      background-color: #357bd6;
    }

    .btn-pdf {
      background-color: #e74c3c;
      color: white;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    .btn-pdf:hover {
      background-color: #c0392b;
    }

    /* MODALES */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    #detalleResultado, #editorEstudiante, #editorExistente {
      background-color: #fff;
      padding: 30px;
      border-radius: 15px;
      max-width: 450px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      transform: scale(0.9);
      opacity: 0;
      transition: all 0.3s ease-out;
      display: none;
    }

    .modal-overlay.active #detalleResultado,
    .modal-overlay.active #editorEstudiante,
    .modal-overlay.active #editorExistente {
      display: block;
      transform: scale(1);
      opacity: 1;
    }

    #detalleResultado h3, #editorEstudiante h3, #editorExistente h3 {
      color: #0a2c58;
      border-bottom: 2px solid #4a90e2;
      padding-bottom: 10px;
      margin-top: 0;
      font-size: 24px;
    }

    #detalleResultado p {
      line-height: 1.6;
      margin: 8px 0;
      font-size: 16px;
    }

    #detalleResultado p strong {
      color: #0a2c58;
      min-width: 120px;
      display: inline-block;
    }

    .nota-final {
      background-color: #e0f2ff;
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      font-weight: bold;
      text-align: center;
      font-size: 1.2em;
    }

    .nota-final span {
      color: #dc3545;
      font-size: 1.3em;
    }

    .btn-cerrar-modal {
      background-color: #6c757d;
      color: white;
      margin-top: 20px;
      width: 100%;
    }

    .btn-cerrar-modal:hover {
      background-color: #545b62;
    }

    .btn-guardar-modal {
      background-color: #28a745;
      color: white;
      margin-top: 20px;
      width: 100%;
    }

    .btn-guardar-modal:hover {
      background-color: #218838;
    }

    #editorEstudiante label, #editorExistente label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }

    #editorEstudiante input, #editorEstudiante select,
    #editorExistente input, #editorExistente select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }

    .mensaje-error {
      color: #dc3545;
      font-size: 14px;
      margin-top: 5px;
    }

    /* Estilo para PDF en preview (no visible en pantalla) */
    #tablaPDF {
      display: none;
    }

    @media print {
      body * {
        visibility: hidden;
      }
      #tablaPDF, #tablaPDF * {
        visibility: visible;
      }
      #tablaPDF {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
    }
  </style>
</head>

<body onload="cargarResultadosFijos()">

  <!-- ENCABEZADO -->
  <div class="encabezado">
    <img src="img/logo_colegio.png" alt="Logo Colegio" id="logoPDF">
    <div class="frase" id="frasePDF">
      <div>Con Excelencia,</div>
      <div>construimos futuro</div>
    </div>
  </div>

  <div class="contenedor-resultados">
    <div class="header-acciones">
      <h1>üìä Resultados Pre-Inscritos</h1>
      <button class="btn-accion btn-agregar" onclick="abrirModalNuevo()">‚ûï Agregar Estudiante</button>
      <button class="btn-accion btn-pdf" onclick="descargarPDF()">üì• Descargar PDF</button>
    </div>

    <!-- TABLA VISIBLE -->
    <table id="tablaVisible">
      <thead>
        <tr>
          <th>C√≥digo</th>
          <th>Nombre y Apellido</th>
          <th>Grado</th>
          <th>Nota (Base 5.0)</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tablaCuerpo"></tbody>
    </table>

    <!-- TABLA PARA PDF (invisible) -->
    <table id="tablaPDF" style="width:100%; border-collapse: collapse; background:#fff; padding:20px;">
      <thead>
        <tr>
          <th style="background:#4a90e2; color:white; padding:10px;">C√≥digo</th>
          <th style="background:#4a90e2; color:white; padding:10px;">Nombre y Apellido</th>
          <th style="background:#4a90e2; color:white; padding:10px;">Grado</th>
          <th style="background:#4a90e2; color:white; padding:10px;">Nota</th>
        </tr>
      </thead>
      <tbody id="tablaCuerpoPDF"></tbody>
    </table>
  </div>

  <div class="modal-overlay" id="modalOverlay">
    <!-- Detalle del resultado -->
    <div id="detalleResultado">
      <h3 id="detalleTitulo">Detalle del Resultado:</h3>
      <div id="detalleDatos"></div>
      <button class="btn-accion btn-cerrar-modal" onclick="cerrarModal()">Cerrar</button>
    </div>

    <!-- Registrar nuevo estudiante -->
    <div id="editorEstudiante">
      <h3>üìù Registrar Nuevo Estudiante</h3>
      <div id="mensajeErrorNuevo" class="mensaje-error"></div>

      <label for="nuevoCodigo">C√≥digo (ej. 106, 107...):</label>
      <input type="number" id="nuevoCodigo" min="101" required>

      <label for="nuevoNombre">Nombre y Apellido:</label>
      <input type="text" id="nuevoNombre" required>

      <label for="nuevoGrado">Grado:</label>
      <select id="nuevoGrado" required>
        <option value="">Seleccione</option>
        <option value="6-1">6-1</option>
        <option value="6-2">6-2</option>
        <option value="7-1">7-1</option>
        <option value="7-2">7-2</option>
        <option value="8-1">8-1</option>
        <option value="8-2">8-2</option>
        <option value="9-1">9-1</option>
        <option value="9-2">9-2</option>
        <option value="10-1">10-1</option>
        <option value="11¬∞">11¬∞</option>
      </select>

      <label for="nuevaNota">Nota (Base 5.0) - opcional:</label>
      <input type="number" id="nuevaNota" min="0" max="5" step="0.1" placeholder="Dejar vac√≠o para '10'">

      <button class="btn-accion btn-guardar-modal" onclick="guardarNuevoEstudiante()">Guardar Estudiante</button>
      <button class="btn-accion btn-cerrar-modal" onclick="cerrarModal()">Cancelar</button>
    </div>

    <!-- Editar estudiante existente -->
    <div id="editorExistente">
      <h3>‚úèÔ∏è Editar Estudiante</h3>
      <div id="mensajeErrorEdicion" class="mensaje-error"></div>

      <label for="editarCodigo">C√≥digo:</label>
      <input type="text" id="editarCodigo" readonly>

      <label for="editarNombre">Nombre y Apellido:</label>
      <input type="text" id="editarNombre" required>

      <label for="editarGrado">Grado:</label>
      <select id="editarGrado" required>
        <option value="6-1">6-1</option>
        <option value="6-2">6-2</option>
        <option value="7-1">7-1</option>
        <option value="7-2">7-2</option>
        <option value="8-1">8-1</option>
        <option value="8-2">8-2</option>
        <option value="9-1">9-1</option>
        <option value="9-2">9-2</option>
        <option value="10-1">10-1</option>
        <option value="11¬∞">11¬∞</option>
      </select>

      <label for="editarNota">Nota (Base 5.0):</label>
      <input type="number" id="editarNota" min="0" max="5" step="0.1" placeholder="Dejar vac√≠o para '10'">

      <button class="btn-accion btn-guardar-modal" onclick="guardarEdicion()">Guardar Cambios</button>
      <button class="btn-accion btn-cerrar-modal" onclick="cerrarModal()">Cancelar</button>
    </div>
  </div>

  <script>
    // === DATOS FIJOS E INICIALIZACI√ìN ===
    const estudiantesFijos = [
      { codigo: '101', nombre: 'Ana Mar√≠a G√≥mez', grado: '6-1' },
      { codigo: '102', nombre: 'Carlos David Torres', grado: '6-2' },
      { codigo: '103', nombre: 'Laura Sof√≠a P√©rez', grado: '6-1' },
      { codigo: '104', nombre: 'Miguel √Ångel Rojas', grado: '6-2' },
      { codigo: '105', nombre: 'Valeria Patricia Castro', grado: '6-2' }
    ];

    const STORAGE_KEY_LISTA = 'lista_estudiantes_adicionales';

    // Obtener lista completa (fijos + adicionales)
    function obtenerListaEstudiantesCompleta() {
      let adicionales = [];
      try {
        const data = localStorage.getItem(STORAGE_KEY_LISTA);
        if (data) adicionales = JSON.parse(data);
      } catch (e) {
        console.error("Error al cargar estudiantes adicionales:", e);
        localStorage.removeItem(STORAGE_KEY_LISTA); // Limpiar si corrupto
      }
      return [...estudiantesFijos, ...adicionales];
    }

    // Guardar lista adicional (solo los no fijos)
    function guardarListaAdicional(lista) {
      const adicionales = lista.filter(est => !estudiantesFijos.some(f => f.codigo === est.codigo));
      localStorage.setItem(STORAGE_KEY_LISTA, JSON.stringify(adicionales));
    }

    // === RENDERIZADO DE TABLA ===
    function cargarResultadosFijos() {
      const cuerpo = document.getElementById('tablaCuerpo');
      const cuerpoPDF = document.getElementById('tablaCuerpoPDF');
      cuerpo.innerHTML = '';
      cuerpoPDF.innerHTML = '';

      let lista = obtenerListaEstudiantesCompleta();
      lista.sort((a, b) => parseInt(a.codigo) - parseInt(b.codigo));

      lista.forEach(est => {
        // Obtener nota desde localStorage (quizz) o asignar "10" si no existe
        const keyQuizz = `resultado_quizz_${est.codigo}`;
        let nota = '10'; // ‚Üê seg√∫n tu instrucci√≥n
        try {
          const dataQuizz = JSON.parse(localStorage.getItem(keyQuizz));
          if (dataQuizz && typeof dataQuizz.nota === 'number') {
            nota = dataQuizz.nota;
          } else if (dataQuizz && dataQuizz.nota != null) {
            nota = dataQuizz.nota;
          }
        } catch (e) {
          // Mantener "10" si error
        }

        // Renderizar en tabla visible
        const fila = cuerpo.insertRow();
        fila.insertCell().textContent = est.codigo;
        fila.insertCell().textContent = est.nombre;
        fila.insertCell().textContent = est.grado;

        const celdaNota = fila.insertCell();
        celdaNota.innerHTML = `<span style="font-weight: bold; color: ${nota === '10' || nota === 'Pendiente' ? '#dc3545' : '#28a745'};">${nota}</span>`;

        const celdaAcciones = fila.insertCell();
        const esFijo = estudiantesFijos.some(f => f.codigo === est.codigo);

        celdaAcciones.innerHTML = `
          <button class="btn-accion btn-editar" title="Editar" onclick="abrirModalEdicion('${est.codigo}')">‚úèÔ∏è</button>
          <button class="btn-accion btn-eliminar" 
                  title="${esFijo ? 'No se puede eliminar estudiante fijo' : 'Eliminar'}"
                  ${esFijo ? 'disabled' : ''} 
                  onclick="eliminarEstudiante('${est.codigo}')">üóëÔ∏è</button>
          <button class="btn-accion ${nota === '10' ? 'btn-inactivo' : 'btn-activo'}" 
                  ${nota === '10' ? 'disabled' : ''} 
                  onclick="verDetalle('${est.codigo}')">
            ${nota === '10' ? 'Pendiente' : 'Ver Resultado'}
          </button>
        `;

        // Renderizar en tabla oculta para PDF
        const filaPDF = cuerpoPDF.insertRow();
        filaPDF.insertCell().textContent = est.codigo;
        filaPDF.insertCell().textContent = est.nombre;
        filaPDF.insertCell().textContent = est.grado;
        const celdaNotaPDF = filaPDF.insertCell();
        celdaNotaPDF.textContent = nota;
        celdaNotaPDF.style.fontWeight = 'bold';
        celdaNotaPDF.style.color = nota === '10' ? '#dc3545' : '#28a745';
      });
    }

    // === MODALES ===
    function abrirModalNuevo() {
      document.getElementById('mensajeErrorNuevo').textContent = '';
      document.getElementById('nuevoCodigo').value = '';
      document.getElementById('nuevoNombre').value = '';
      document.getElementById('nuevoGrado').value = '';
      document.getElementById('nuevaNota').value = '';

      mostrarModal('editorEstudiante');
    }

    function abrirModalEdicion(codigo) {
      const lista = obtenerListaEstudiantesCompleta();
      const est = lista.find(e => e.codigo === codigo);
      if (!est) return;

      document.getElementById('mensajeErrorEdicion').textContent = '';
      document.getElementById('editarCodigo').value = est.codigo;
      document.getElementById('editarNombre').value = est.nombre;
      document.getElementById('editarGrado').value = est.grado;

      // Buscar nota en quizz o usar "10"
      const key = `resultado_quizz_${codigo}`;
      let nota = '10';
      try {
        const data = JSON.parse(localStorage.getItem(key));
        if (data && data.nota != null) nota = data.nota;
      } catch (e) {}

      document.getElementById('editarNota').value = nota === '10' ? '' : nota;

      mostrarModal('editorExistente');
    }

    function verDetalle(codigo) {
      const key = `resultado_quizz_${codigo}`;
      const dataString = localStorage.getItem(key);
      const detalleDatos = document.getElementById('detalleDatos');

      if (!dataString) {
        detalleDatos.innerHTML = `<p style="color:red; text-align:center;">No hay datos del examen para el c√≥digo ${codigo}.</p>`;
      } else {
        const data = JSON.parse(dataString);
        const contenido = `
          <p>üë§ <strong>Estudiante:</strong> ${data.nombre || 'N/A'}</p>
          <p>üéì <strong>Grado:</strong> ${data.grado || 'N/A'}</p>
          <p>üÜî <strong>C√≥digo:</strong> ${codigo}</p>
          <p>‚úÖ <strong>Estado:</strong> Completado</p>
          <p>‚≠ê <strong>Puntuaci√≥n:</strong> ${data.puntuacion || 'N/A'}</p>
          <div class="nota-final">
            NOTA FINAL: <span>${data.nota || 'N/A'}</span> / 5.0
          </div>
          <p>üìÖ <strong>Fecha:</strong> ${data.fecha || 'N/A'}</p>
          <p>‚è±Ô∏è <strong>Hora de Inicio:</strong> ${data.horaInicio || 'N/A'}</p>
          <p>‚è±Ô∏è <strong>Hora de Fin:</strong> ${data.horaFin || 'N/A'}</p>
        `;
        document.getElementById('detalleTitulo').textContent = `Detalle de ${data.nombre || 'Estudiante'} (${codigo})`;
        detalleDatos.innerHTML = contenido;
      }

      mostrarModal('detalleResultado');
    }

    function mostrarModal(id) {
      document.querySelectorAll('#modalOverlay > div').forEach(d => d.style.display = 'none');
      document.getElementById(id).style.display = 'block';
      document.getElementById('modalOverlay').style.display = 'flex';
      document.getElementById('modalOverlay').classList.add('active');
    }

    function cerrarModal() {
      document.getElementById('modalOverlay').classList.remove('active');
      setTimeout(() => {
        document.getElementById('modalOverlay').style.display = 'none';
      }, 300);
    }

    // === GUARDAR NUEVO ESTUDIANTE ===
    function guardarNuevoEstudiante() {
      const codigo = document.getElementById('nuevoCodigo').value.trim();
      const nombre = document.getElementById('nuevoNombre').value.trim();
      const grado = document.getElementById('nuevoGrado').value;
      const notaInput = document.getElementById('nuevaNota').value.trim();
      const errorDiv = document.getElementById('mensajeErrorNuevo');

      if (!codigo || !nombre || !grado) {
        errorDiv.textContent = 'Todos los campos son obligatorios.';
        return;
      }

      if (isNaN(codigo) || parseInt(codigo) < 101) {
        errorDiv.textContent = 'C√≥digo inv√°lido. Debe ser ‚â• 101.';
        return;
      }

      // Validar duplicado
      const lista = obtenerListaEstudiantesCompleta();
      if (lista.some(e => e.codigo === codigo)) {
        errorDiv.textContent = `El c√≥digo ${codigo} ya est√° en uso.`;
        return;
      }

      // Guardar estudiante
      const nuevo = { codigo, nombre, grado };
      const listaActual = obtenerListaEstudiantesCompleta();
      const nuevaLista = [...listaActual, nuevo];
      guardarListaAdicional(nuevaLista);

      // Guardar nota si se dio (sino, dejar "10" por defecto)
      if (notaInput !== '') {
        const nota = parseFloat(notaInput);
        if (nota < 0 || nota > 5) {
          errorDiv.textContent = 'La nota debe estar entre 0 y 5.';
          return;
        }
        const key = `resultado_quizz_${codigo}`;
        const data = {
          nombre,
          grado,
          nota,
          puntuacion: nota * 20, // ej: 5.0 ‚Üí 100%
          fecha: new Date().toLocaleDateString(),
          horaInicio: "N/A",
          horaFin: "N/A"
        };
        localStorage.setItem(key, JSON.stringify(data));
      }

      errorDiv.textContent = '';
      cerrarModal();
      cargarResultadosFijos();
    }

    // === GUARDAR EDICI√ìN ===
    function guardarEdicion() {
      const codigo = document.getElementById('editarCodigo').value;
      const nombre = document.getElementById('editarNombre').value.trim();
      const grado = document.getElementById('editarGrado').value;
      const notaInput = document.getElementById('editarNota').value.trim();
      const errorDiv = document.getElementById('mensajeErrorEdicion');

      if (!nombre || !grado) {
        errorDiv.textContent = 'Nombre y grado son obligatorios.';
        return;
      }

      const lista = obtenerListaEstudiantesCompleta();
      const index = lista.findIndex(e => e.codigo === codigo);
      if (index === -1) {
        errorDiv.textContent = 'Estudiante no encontrado.';
        return;
      }

      // Actualizar datos
      lista[index].nombre = nombre;
      lista[index].grado = grado;

      // Actualizar nota en localStorage si aplica
      const key = `resultado_quizz_${codigo}`;
      let dataQuizz = null;
      try {
        dataQuizz = JSON.parse(localStorage.getItem(key)) || {};
      } catch (e) { dataQuizz = {}; }

      if (notaInput === '') {
        // Eliminar nota ‚Üí se mostrar√° "10"
        if (dataQuizz) {
          delete dataQuizz.nota;
          delete dataQuizz.puntuacion;
          localStorage.setItem(key, JSON.stringify(dataQuizz));
        }
      } else {
        const nota = parseFloat(notaInput);
        if (nota < 0 || nota > 5) {
          errorDiv.textContent = 'La nota debe estar entre 0 y 5.';
          return;
        }
        dataQuizz = {
          ...dataQuizz,
          nombre,
          grado,
          nota,
          puntuacion: nota * 20
        };
        localStorage.setItem(key, JSON.stringify(dataQuizz));
      }

      // Guardar lista (solo adicionales)
      guardarListaAdicional(lista);
      errorDiv.textContent = '';
      cerrarModal();
      cargarResultadosFijos();
    }

    // === ELIMINAR ESTUDIANTE ===
    function eliminarEstudiante(codigo) {
      if (!confirm(`¬øSeguro que desea eliminar al estudiante con c√≥digo ${codigo}?`)) return;

      const esFijo = estudiantesFijos.some(f => f.codigo === codigo);
      if (esFijo) {
        alert("No se pueden eliminar estudiantes fijos.");
        return;
      }

      // Eliminar de lista adicional
      let lista = obtenerListaEstudiantesCompleta();
      lista = lista.filter(e => e.codigo !== codigo);
      guardarListaAdicional(lista);

      // Eliminar datos de quizz
      localStorage.removeItem(`resultado_quizz_${codigo}`);

      cargarResultadosFijos();
    }

    // === DESCARGAR PDF ===
    async function descargarPDF() {
      alert("Preparando PDF... Esto puede tardar unos segundos.");

      // Actualizar tabla PDF con datos actuales
      cargarResultadosFijos(); // Esto ya actualiza tablaPDF

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'mm', 'a4');

      // T√≠tulo
      doc.setFontSize(18);
      doc.setTextColor(10, 44, 88);
      doc.text("üìä Resultados Pre-Inscritos", 105, 20, null, null, 'center');

      // Frase institucional
      doc.setFontSize(12);
      doc.setTextColor(10, 44, 88);
      doc.text("Con Excelencia,", 105, 30, null, null, 'center');
      doc.text("construimos futuro", 105, 35, null, null, 'center');

      // Tabla
      const tablaPDF = document.getElementById('tablaPDF');
      doc.setFontSize(10);

      // Usar html2canvas para renderizar la tabla (m√°s f√°cil y con estilo)
      const canvas = await html2canvas(tablaPDF, {
        scale: 2,
        backgroundColor: null,
        useCORS: true
      });

      const imgData = canvas.toDataURL('image/png');
      const imgWidth = 190;
      const pageHeight = 295;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;

      let heightLeft = imgHeight;
      let position = 50;

      doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;

      while (heightLeft >= 0) {
        doc.addPage();
        position = heightLeft - imgHeight;
        doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
      }

      doc.save(`resultados_${new Date().toISOString().slice(0,10)}.pdf`);
    }
  </script>

</body>
</html>