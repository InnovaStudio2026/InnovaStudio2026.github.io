<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Tabla de Resultados - Docente</title>
  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0d3b66, #1a5699, #2c78d3);
      padding: 20px;
      color: #333;
      margin: 0;
    }

    .encabezado {
      display: flex;
      justify-content: center; /* ‚úÖ Centrado horizontal */
      align-items: center;
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(8px);
      padding: 20px 35px;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(13, 59, 102, 0.25);
      margin-bottom: 30px;
      border: 1px solid rgba(255, 255, 255, 0.4);
    }

    .encabezado-contenido {
      display: flex;
      align-items: center;
      gap: 20px; /* ‚úÖ Espacio entre logo y frase */
    }

    .encabezado img {
      height: 85px;
      width: auto;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,0.1));
    }

    .frase {
      text-align: left; /* ‚úÖ Alineaci√≥n natural dentro del grupo */
      color: #0d3b66;
      font-style: italic;
      font-size: 22px;
      line-height: 1.3;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(255,255,255,0.7);
    }

    .contenedor-resultados {
      background-color: #fff;
      padding: 35px;
      border-radius: 18px;
      max-width: 920px;
      margin: 0 auto 40px auto;
      box-shadow: 0 12px 30px rgba(13, 59, 102, 0.2);
      border: 1px solid rgba(230, 230, 230, 0.8);
    }

    h1 {
      color: #0d3b66;
      border-bottom: 3px solid #f9a826;
      padding-bottom: 12px;
      margin-bottom: 25px;
      text-align: center;
      font-weight: 700;
      font-size: 28px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.03);
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      padding: 14px 18px;
      text-align: left;
      border-bottom: 1px solid #eaeef5;
    }

    th {
      background: linear-gradient(to bottom, #0d3b66, #1a5699);
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 14px;
    }

    tr:nth-child(even) {
      background-color: #fbfcfe;
    }

    tr:hover {
      background-color: #f0f6ff;
    }

    .btn-accion {
      padding: 8px 16px;
      margin: 3px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.25s ease;
      min-width: 95px;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .btn-accion:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .btn-editar {
      background: linear-gradient(to right, #f9a826, #e69500);
      color: white;
    }

    .btn-editar:hover {
      background: linear-gradient(to right, #e69500, #d48200);
    }

    .btn-eliminar {
      background: linear-gradient(to right, #d32f2f, #b71c1c);
      color: white;
    }

    .btn-eliminar:hover {
      background: linear-gradient(to right, #b71c1c, #9e1a1a);
    }

    .btn-eliminar:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-activo {
      background: linear-gradient(to right, #2e7d32, #1b5e20);
      color: white;
    }

    .btn-activo:hover {
      background: linear-gradient(to right, #1b5e20, #0d4c1a);
    }

    .btn-inactivo {
      background: linear-gradient(to right, #757575, #616161);
      color: white;
      opacity: 0.9;
      cursor: not-allowed;
    }

    .btn-inactivo:hover {
      transform: none;
      box-shadow: none;
    }

    .btn-volver {
      background: linear-gradient(to right, #607d8b, #455a64);
      color: white;
    }

    .btn-volver:hover {
      background: linear-gradient(to right, #455a64, #37474f);
    }

    .header-acciones {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .btn-agregar {
      background: linear-gradient(to right, #1976d2, #0d47a1);
      color: white;
    }

    .btn-agregar:hover {
      background: linear-gradient(to right, #0d47a1, #0a3982);
    }

    .btn-pdf {
      background: linear-gradient(to right, #c62828, #b71c1c);
      color: white;
      padding: 9px 18px;
      border-radius: 8px;
    }

    .btn-pdf:hover {
      background: linear-gradient(to right, #b71c1c, #9e1a1a);
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(13, 59, 102, 0.75);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    #detalleResultado, #editorEstudiante, #editorExistente {
      background-color: #fff;
      padding: 35px;
      border-radius: 18px;
      max-width: 480px;
      width: 90%;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
      transform: scale(0.92);
      opacity: 0;
      transition: all 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .modal-overlay.active #detalleResultado,
    .modal-overlay.active #editorEstudiante,
    .modal-overlay.active #editorExistente {
      display: block;
      transform: scale(1);
      opacity: 1;
    }

    #detalleResultado h3, #editorEstudiante h3, #editorExistente h3 {
      color: #0d3b66;
      border-bottom: 3px solid #f9a826;
      padding-bottom: 12px;
      margin-top: 0;
      font-size: 26px;
      font-weight: 700;
    }

    #detalleResultado p {
      line-height: 1.65;
      margin: 10px 0;
      font-size: 16px;
      color: #444;
    }

    #detalleResultado p strong {
      color: #0d3b66;
      min-width: 130px;
      display: inline-block;
    }

    .nota-final {
      background: linear-gradient(to right, #e3f2fd, #bbdefb);
      padding: 18px;
      border-radius: 12px;
      margin-top: 22px;
      font-weight: bold;
      text-align: center;
      font-size: 1.3em;
      border: 1px dashed #90caf9;
    }

    .nota-final span {
      color: #d32f2f;
      font-size: 1.4em;
      font-weight: 800;
    }

    .btn-cerrar-modal, .btn-guardar-modal {
      padding: 10px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 15px;
      margin-top: 22px;
    }

    .btn-cerrar-modal {
      background: linear-gradient(to right, #607d8b, #455a64);
      color: white;
    }

    .btn-cerrar-modal:hover {
      background: linear-gradient(to right, #455a64, #37474f);
    }

    .btn-guardar-modal {
      background: linear-gradient(to right, #2e7d32, #1b5e20);
      color: white;
    }

    .btn-guardar-modal:hover {
      background: linear-gradient(to right, #1b5e20, #0d4c1a);
    }

    #editorEstudiante label, #editorExistente label {
      display: block;
      margin-top: 14px;
      font-weight: 600;
      color: #0d3b66;
    }

    #editorEstudiante input, #editorEstudiante select,
    #editorExistente input, #editorExistente select {
      width: 100%;
      padding: 12px;
      margin-top: 6px;
      border: 1px solid #cbd5e0;
      border-radius: 8px;
      box-sizing: border-box;
      font-size: 15px;
      transition: border-color 0.2s;
    }

    #editorEstudiante input:focus, #editorEstudiante select:focus,
    #editorExistente input:focus, #editorExistente select:focus {
      outline: none;
      border-color: #f9a826;
      box-shadow: 0 0 0 3px rgba(249, 168, 38, 0.2);
    }

    .mensaje-error {
      color: #d32f2f;
      font-size: 14px;
      margin-top: 6px;
      font-weight: 500;
    }

    #tablaPDF { display: none; }
  </style>
</head>

<body onload="cargarResultadosFijos()">

  <!-- ‚úÖ ENCABEZADO CORREGIDO: logo + frase centrados -->
  <div class="encabezado">
    <div class="encabezado-contenido">
      <img src="img/icono.png" alt="Logo Colegio" id="logoPDF">
      <div class="frase" id="frasePDF">
        <div>Con Excelencia,</div>
        <div>construimos futuro</div>
      </div>
    </div>
  </div>

  <div class="contenedor-resultados">
    <div class="header-acciones">
      <h1>üìä Resultados Examen</h1>
      <button class="btn-accion btn-agregar" onclick="abrirModalNuevo()">‚ûï Agregar Estudiante</button>
      <button class="btn-accion btn-pdf" onclick="descargarPDF()">üì• Descargar PDF</button>
    </div>

    <table id="tablaVisible">
      <thead>
        <tr>
          <th>C√≥digo</th>
          <th>Nombre y Apellido</th>
          <th>Grado</th>
          <th>Nota (Base 5.0)</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tablaCuerpo"></tbody>
    </table>
  </div>

  <div class="modal-overlay" id="modalOverlay">
    <div id="detalleResultado">
      <h3 id="detalleTitulo">Detalle del Resultado:</h3>
      <div id="detalleDatos"></div>
      <button class="btn-accion btn-cerrar-modal" onclick="cerrarModal()">Cerrar</button>
    </div>

    <div id="editorEstudiante">
      <h3>üìù Registrar Nuevo Estudiante</h3>
      <div id="mensajeErrorNuevo" class="mensaje-error"></div>

      <label for="nuevoCodigo">C√≥digo (ej. 106, 107...):</label>
      <input type="number" id="nuevoCodigo" min="101" required>
      <label for="nuevoNombre">Nombre y Apellido:</label>
      <input type="text" id="nuevoNombre" required>
      <label for="nuevoGrado">Grado:</label>
      <select id="nuevoGrado" required>
        <option value="">Seleccione</option>
        <option value="6-1">6-1</option>
        <option value="6-2">6-2</option>
        <option value="7-1">7-1</option>
        <option value="7-2">7-2</option>
        <option value="8-1">8-1</option>
        <option value="8-2">8-2</option>
        <option value="9-1">9-1</option>
        <option value="9-2">9-2</option>
        <option value="10-1">10-1</option>
        <option value="11¬∞">11¬∞</option>
      </select>
      <label for="nuevaNota">Nota (Base 5.0) - opcional:</label>
      <input type="number" id="nuevaNota" min="0" max="5" step="0.1" placeholder="Dejar vac√≠o para '10'">
      <button class="btn-accion btn-guardar-modal" onclick="guardarNuevoEstudiante()">Guardar Estudiante</button>
      <button class="btn-accion btn-cerrar-modal" onclick="cerrarModal()">Cancelar</button>
    </div>

    <div id="editorExistente">
      <h3>‚úèÔ∏è Editar Estudiante</h3>
      <div id="mensajeErrorEdicion" class="mensaje-error"></div>
      <label for="editarCodigo">C√≥digo:</label>
      <input type="text" id="editarCodigo" readonly>
      <label for="editarNombre">Nombre y Apellido:</label>
      <input type="text" id="editarNombre" required>
      <label for="editarGrado">Grado:</label>
      <select id="editarGrado" required>
        <option value="6-1">6-1</option>
        <option value="6-2">6-2</option>
        <option value="7-1">7-1</option>
        <option value="7-2">7-2</option>
        <option value="8-1">8-1</option>
        <option value="8-2">8-2</option>
        <option value="9-1">9-1</option>
        <option value="9-2">9-2</option>
        <option value="10-1">10-1</option>
        <option value="11¬∞">11¬∞</option>
      </select>
      <label for="editarNota">Nota (Base 5.0):</label>
      <input type="number" id="editarNota" min="0" max="5" step="0.1" placeholder="Dejar vac√≠o para '10'">
      <button class="btn-accion btn-guardar-modal" onclick="guardarEdicion()">Guardar Cambios</button>
      <button class="btn-accion btn-cerrar-modal" onclick="cerrarModal()">Cancelar</button>
    </div>
  </div>

  <script>
    const estudiantesFijos = [
      { codigo: '101', nombre: 'Ana Mar√≠a G√≥mez', grado: '6-1' },
      { codigo: '102', nombre: 'Carlos David Torres', grado: '6-2' },
      { codigo: '103', nombre: 'Laura Sof√≠a P√©rez', grado: '6-1' },
      { codigo: '104', nombre: 'Miguel √Ångel Rojas', grado: '6-2' },
      { codigo: '105', nombre: 'Valeria Patricia Castro', grado: '6-2' }
    ];

    const STORAGE_KEY_LISTA = 'lista_estudiantes_adicionales';

    function obtenerListaEstudiantesCompleta() {
      let adicionales = [];
      try {
        const data = localStorage.getItem(STORAGE_KEY_LISTA);
        if (data) adicionales = JSON.parse(data);
      } catch (e) {
        console.error("Error al cargar estudiantes adicionales:", e);
        localStorage.removeItem(STORAGE_KEY_LISTA);
      }
      return [...estudiantesFijos, ...adicionales];
    }

    function guardarListaAdicional(lista) {
      const adicionales = lista.filter(est => !estudiantesFijos.some(f => f.codigo === est.codigo));
      localStorage.setItem(STORAGE_KEY_LISTA, JSON.stringify(adicionales));
    }

    function cargarResultadosFijos() {
      const cuerpo = document.getElementById('tablaCuerpo');
      cuerpo.innerHTML = '';

      let lista = obtenerListaEstudiantesCompleta();
      lista.sort((a, b) => parseInt(a.codigo) - parseInt(b.codigo));

      lista.forEach(est => {
        const key = `resultado_quizz_${est.codigo}`;
        let nota = '10';
        try {
          const data = JSON.parse(localStorage.getItem(key));
          if (data && data.nota != null) {
            nota = typeof data.nota === 'number' ? data.nota.toFixed(1) : String(data.nota);
          }
        } catch (e) {}

        const fila = cuerpo.insertRow();
        fila.insertCell().textContent = est.codigo;
        fila.insertCell().textContent = est.nombre;
        fila.insertCell().textContent = est.grado;

        const celdaNota = fila.insertCell();
        celdaNota.innerHTML = `<span style="font-weight: bold; color: ${nota === '10' ? '#d32f2f' : '#2e7d32'};">${nota}</span>`;

        const esFijo = estudiantesFijos.some(f => f.codigo === est.codigo);
        const celdaAcciones = fila.insertCell();
        celdaAcciones.innerHTML = `
          <button class="btn-accion btn-editar" title="Editar" onclick="abrirModalEdicion('${est.codigo}')">‚úèÔ∏è</button>
          <button class="btn-accion btn-eliminar" 
                  title="${esFijo ? 'No se puede eliminar estudiante fijo' : 'Eliminar'}"
                  ${esFijo ? 'disabled' : ''} 
                  onclick="eliminarEstudiante('${est.codigo}')">üóëÔ∏è</button>
          <button class="btn-accion ${nota === '10' ? 'btn-inactivo' : 'btn-activo'}" 
                  ${nota === '10' ? 'disabled' : ''} 
                  onclick="verDetalle('${est.codigo}')">
            ${nota === '10' ? 'Pendiente' : 'Ver Resultado'}
          </button>
        `;
      });
    }

    function abrirModalNuevo() {
      document.getElementById('mensajeErrorNuevo').textContent = '';
      document.getElementById('nuevoCodigo').value = '';
      document.getElementById('nuevoNombre').value = '';
      document.getElementById('nuevoGrado').value = '';
      document.getElementById('nuevaNota').value = '';
      mostrarModal('editorEstudiante');
    }

    function abrirModalEdicion(codigo) {
      const lista = obtenerListaEstudiantesCompleta();
      const est = lista.find(e => e.codigo === codigo);
      if (!est) return;

      document.getElementById('mensajeErrorEdicion').textContent = '';
      document.getElementById('editarCodigo').value = est.codigo;
      document.getElementById('editarNombre').value = est.nombre;
      document.getElementById('editarGrado').value = est.grado;

      const key = `resultado_quizz_${codigo}`;
      let nota = '10';
      try {
        const data = JSON.parse(localStorage.getItem(key));
        if (data && data.nota != null) nota = data.nota;
      } catch (e) {}

      document.getElementById('editarNota').value = nota === '10' ? '' : nota;
      mostrarModal('editorExistente');
    }

    function verDetalle(codigo) {
      const key = `resultado_quizz_${codigo}`;
      const dataString = localStorage.getItem(key);
      const detalleDatos = document.getElementById('detalleDatos');

      if (!dataString) {
        detalleDatos.innerHTML = `<p style="color:#d32f2f; text-align:center;">No hay datos del examen para el c√≥digo ${codigo}.</p>`;
      } else {
        const data = JSON.parse(dataString);
        const contenido = `
          <p>üë§ <strong>Estudiante:</strong> ${data.nombre || 'N/A'}</p>
          <p>üìà <strong>Grado:</strong> ${data.grado || 'N/A'}</p>
          <p>üÜî <strong>C√≥digo:</strong> ${codigo}</p>
          <p>‚úÖ <strong>Estado:</strong> Completado</p>
          <p>‚≠ê <strong>Puntuaci√≥n:</strong> ${data.puntuacion || 'N/A'}</p>
          <div class="nota-final">
            NOTA FINAL: <span>${data.nota != null ? (typeof data.nota === 'number' ? data.nota.toFixed(1) : data.nota) : 'N/A'}</span> / 5.0
          </div>
          <p>üìÖ <strong>Fecha:</strong> ${data.fecha || 'N/A'}</p>
          <p>‚è±Ô∏è <strong>Hora de Inicio:</strong> ${data.horaInicio || 'N/A'}</p>
          <p>‚è±Ô∏è <strong>Hora de Fin:</strong> ${data.horaFin || 'N/A'}</p>
        `;
        document.getElementById('detalleTitulo').textContent = `Detalle de ${data.nombre || 'Estudiante'} (${codigo})`;
        detalleDatos.innerHTML = contenido;
      }
      mostrarModal('detalleResultado');
    }

    function mostrarModal(id) {
      document.querySelectorAll('#modalOverlay > div').forEach(d => d.style.display = 'none');
      document.getElementById(id).style.display = 'block';
      document.getElementById('modalOverlay').style.display = 'flex';
      document.getElementById('modalOverlay').classList.add('active');
    }

    function cerrarModal() {
      document.getElementById('modalOverlay').classList.remove('active');
      setTimeout(() => {
        document.getElementById('modalOverlay').style.display = 'none';
      }, 350);
    }

    function guardarNuevoEstudiante() {
      const codigo = document.getElementById('nuevoCodigo').value.trim();
      const nombre = document.getElementById('nuevoNombre').value.trim();
      const grado = document.getElementById('nuevoGrado').value;
      const notaInput = document.getElementById('nuevaNota').value.trim();
      const errorDiv = document.getElementById('mensajeErrorNuevo');

      if (!codigo || !nombre || !grado) {
        errorDiv.textContent = 'Todos los campos son obligatorios.';
        return;
      }
      if (isNaN(codigo) || parseInt(codigo) < 101) {
        errorDiv.textContent = 'C√≥digo inv√°lido. Debe ser ‚â• 101.';
        return;
      }
      const lista = obtenerListaEstudiantesCompleta();
      if (lista.some(e => e.codigo === codigo)) {
        errorDiv.textContent = `El c√≥digo ${codigo} ya est√° en uso.`;
        return;
      }

      const nuevo = { codigo, nombre, grado };
      const listaActual = obtenerListaEstudiantesCompleta();
      const nuevaLista = [...listaActual, nuevo];
      guardarListaAdicional(nuevaLista);

      if (notaInput !== '') {
        const nota = parseFloat(notaInput);
        if (nota < 0 || nota > 5) {
          errorDiv.textContent = 'La nota debe estar entre 0 y 5.';
          return;
        }
        const key = `resultado_quizz_${codigo}`;
        const data = {
          nombre,
          grado,
          nota,
          puntuacion: nota * 20,
          fecha: new Date().toLocaleDateString(),
          horaInicio: "N/A",
          horaFin: "N/A"
        };
        localStorage.setItem(key, JSON.stringify(data));
      }

      errorDiv.textContent = '';
      cerrarModal();
      cargarResultadosFijos();
    }

    function guardarEdicion() {
      const codigo = document.getElementById('editarCodigo').value;
      const nombre = document.getElementById('editarNombre').value.trim();
      const grado = document.getElementById('editarGrado').value;
      const notaInput = document.getElementById('editarNota').value.trim();
      const errorDiv = document.getElementById('mensajeErrorEdicion');

      if (!nombre || !grado) {
        errorDiv.textContent = 'Nombre y grado son obligatorios.';
        return;
      }

      const lista = obtenerListaEstudiantesCompleta();
      const index = lista.findIndex(e => e.codigo === codigo);
      if (index === -1) {
        errorDiv.textContent = 'Estudiante no encontrado.';
        return;
      }

      lista[index].nombre = nombre;
      lista[index].grado = grado;

      const key = `resultado_quizz_${codigo}`;
      let dataQuizz = null;
      try {
        dataQuizz = JSON.parse(localStorage.getItem(key)) || {};
      } catch (e) { dataQuizz = {}; }

      if (notaInput === '') {
        if (dataQuizz) {
          delete dataQuizz.nota;
          delete dataQuizz.puntuacion;
          localStorage.setItem(key, JSON.stringify(dataQuizz));
        }
      } else {
        const nota = parseFloat(notaInput);
        if (nota < 0 || nota > 5) {
          errorDiv.textContent = 'La nota debe estar entre 0 y 5.';
          return;
        }
        dataQuizz = {
          ...dataQuizz,
          nombre,
          grado,
          nota,
          puntuacion: nota * 20
        };
        localStorage.setItem(key, JSON.stringify(dataQuizz));
      }

      guardarListaAdicional(lista);
      errorDiv.textContent = '';
      cerrarModal();
      cargarResultadosFijos();
    }

    function eliminarEstudiante(codigo) {
      if (!confirm(`¬øSeguro que desea eliminar al estudiante con c√≥digo ${codigo}?`)) return;

      const esFijo = estudiantesFijos.some(f => f.codigo === codigo);
      if (esFijo) {
        alert("No se pueden eliminar estudiantes fijos.");
        return;
      }

      let lista = obtenerListaEstudiantesCompleta();
      lista = lista.filter(e => e.codigo !== codigo);
      guardarListaAdicional(lista);
      localStorage.removeItem(`resultado_quizz_${codigo}`);
      cargarResultadosFijos();
    }

    function descargarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'mm', 'a4');

      const width = doc.internal.pageSize.width;
      const height = doc.internal.pageSize.height;

      doc.setFillColor(255, 255, 255);
      doc.rect(0, 0, width, height, 'F');

      doc.setTextColor(0, 0, 0);

      doc.setFont("helvetica", "bold");
      doc.setFontSize(20);
      doc.text("COLEGIO INSTITUCI√ìN EDUCATIVA COLUCAS", width / 2, 25, { align: "center" });

      doc.setFontSize(14);
      doc.setFont("helvetica", "italic");
      doc.text("Con Excelencia, construimos futuro", width / 2, 35, { align: "center" });

      doc.setDrawColor(0, 0, 0);
      doc.setLineWidth(0.5);
      doc.line(20, 42, width - 20, 42);

      doc.setFontSize(18);
      doc.setFont("helvetica", "bold");
      doc.text("RESULTADOS PRE-INSCRITOS", width / 2, 55, { align: "center" });

      doc.setFontSize(10);
      doc.setFont("helvetica", "normal");
      doc.text(`Generado el: ${new Date().toLocaleDateString('es-ES')}`, width / 2, 63, { align: "center" });

      const lista = obtenerListaEstudiantesCompleta().sort((a, b) => parseInt(a.codigo) - parseInt(b.codigo));
      const rows = lista.map(est => {
        let notaMostrar = "10";
        const key = `resultado_quizz_${est.codigo}`;
        const dataStr = localStorage.getItem(key);
        if (dataStr) {
          try {
            const data = JSON.parse(dataStr);
            if (data.nota != null && !isNaN(parseFloat(data.nota))) {
              notaMostrar = parseFloat(data.nota).toFixed(1);
            }
          } catch (e) { }
        }
        return [est.codigo, est.nombre, est.grado, notaMostrar];
      });

      doc.autoTable({
        head: [['C√≥digo', 'Nombre y Apellido', 'Grado', 'Nota']],
        body: rows,
        startY: 72,
        margin: { left: 18, right: 18 },
        theme: 'grid',
        headStyles: {
          fillColor: [30, 30, 30],
          textColor: [255, 255, 255],
          fontSize: 11,
          font: 'helvetica',
          fontStyle: 'bold'
        },
        bodyStyles: {
          fontSize: 10,
          font: 'helvetica',
          textColor: [0, 0, 0],
          cellPadding: 4
        },
        columnStyles: {
          0: { cellWidth: 25, halign: 'center' },
          1: { cellWidth: 70 },
          2: { cellWidth: 30, halign: 'center' },
          3: {
            cellWidth: 25,
            halign: 'center',
            textColor: (cell) => cell.raw === "10" ? [220, 53, 69] : [0, 0, 0]
          }
        },
        didParseCell: (data) => {
          if (data.section === 'body' && data.column.index === 3 && data.cell.raw !== "10") {
            data.cell.styles.fontStyle = 'bold';
          }
        }
      });

      const finalY = doc.lastAutoTable.finalY + 15;
      doc.setTextColor(0, 0, 0);
      doc.setFontSize(9);
      doc.setFont("helvetica", "normal");
      doc.text("Documento generado autom√°ticamente. Valide en sistema institucional.", 
               width / 2, 
               Math.max(finalY, height - 15), 
               { align: "center" });

      doc.save(`resultados_preinscritos_${new Date().toISOString().slice(0,10)}.pdf`);
    }
  </script>

</body>
</html>